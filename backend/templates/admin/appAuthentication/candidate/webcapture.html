{% extends 'admin/base_site.html' %}
{% load static %}

{# remove the header branding #}
{% block branding %}
{% endblock %}

{# remove the top global nav (user/menu) #}
{% block nav-global %}
{% endblock %}

{# remove the breadcrumb trail #}
{% block breadcrumbs %}
{% endblock %}

{# remove the entire sidebar navigation #}
{% block nav-sidebar %}
{% endblock %}

{% block sidebar %}
{% endblock %}

{% block title %}
Webcam Capture
{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
/* hide header bar */
#header, .breadcrumbs-wrapper { display: none !important; }
/* hide sidebar container */
#sidebar, #sidebar-toggle, .module.sidebar-module { display: none !important; }
/* make content full-width */
#content { margin-left: 0 !important; }

.candidate-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.candidate-card:hover {
    background-color: #f8f9fa;
    border-color: #007bff;
}

.candidate-card.selected {
    background-color: #e3f2fd;
    border-color: #2196f3;
    border-width: 2px;
}

.candidate-details {
    display: none;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #eee;
}

.candidate-details.show {
    display: block;
}

.capture-section {
    display: none;
    margin-top: 20px;
    padding: 20px;
    border: 2px dashed #007bff;
    border-radius: 8px;
    background-color: #f8f9fa;
}

.capture-section.show {
    display: block;
}

.search-results {
    max-height: 400px;
    overflow-y: auto;
}

.step-indicator {
    display: flex;
    justify-content: center;
    margin-bottom: 30px;
}

.step {
    display: flex;
    align-items: center;
    margin: 0 10px;
}

.step-number {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: #ddd;
    color: #666;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 8px;
    font-weight: bold;
}

.step.active .step-number {
    background-color: #007bff;
    color: white;
}

.step.completed .step-number {
    background-color: #28a745;
    color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 900px; margin-top: 2rem;">
    
    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="step" id="step1" data-step="1">
            <div class="step-number">1</div>
            <span>Search Candidate</span>
        </div>
        <div class="step" id="step2" data-step="2">
            <div class="step-number">2</div>
            <span>Select Candidate</span>
        </div>
        <div class="step" id="step3" data-step="3">
            <div class="step-number">3</div>
            <span>Capture Photo</span>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Capture Candidate Profile Image</h3>
        </div>
        <div class="card-body">
            
            {% if success %}
            <div class="alert alert-success">
                Photo captured and saved for <strong>{{ selected_candidate.first_name }} {{ selected_candidate.last_name }}</strong> (Symbol: {{ selected_candidate.symbol_number }})
            </div>
            {% endif %}

            <!-- Step 1: Search -->
            <div id="search-section">
                <h5>Step 1: Search Candidate</h5>
                <form method="post" class="mb-4">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="search">
                    <div class="row">
                        <div class="col-md-8">
                            <input type="text" 
                                   name="search_query" 
                                   id="search_query" 
                                   class="form-control" 
                                   placeholder="Search by symbol number, name, or email..."
                                   value="{{ search_query|default:'' }}"
                                   required>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary w-100">Search</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Step 2: Search Results -->
            {% if candidates %}
            <div id="results-section">
                <h5>Step 2: Select Candidate ({{ candidates|length }} result{{ candidates|length|pluralize }} found)</h5>
                <div class="search-results">
                    {% for candidate in candidates %}
                    <div class="candidate-card" data-candidate-id="{{ candidate.id }}" onclick="selectCandidate({{ candidate.id }})">
                        <div class="row">
                            <div class="col-md-2">
                                {% if candidate.profile_image %}
                                <img src="{{ candidate.profile_image.url }}" alt="Profile" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;">
                                {% else %}
                                <div style="width: 60px; height: 60px; background-color: #f0f0f0; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-user" style="color: #ccc;"></i>
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-10">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>{{ candidate.first_name }} {{ candidate.last_name }}</strong>
                                        <br><small class="text-muted">Symbol: {{ candidate.symbol_number }}</small>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">{{ candidate.email }}</small>
                                        <br><small class="text-muted">Click to expand details</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Expanded Details (hidden by default) -->
                        <div class="candidate-details" id="details-{{ candidate.id }}">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Contact Information:</strong><br>
                                    Email: {{ candidate.email }}<br>
                                    {% if candidate.phone %}Phone: {{ candidate.phone }}<br>{% endif %}
                                </div>
                                <div class="col-md-6">
                                    <strong>Election Details:</strong><br>
                                    Symbol Number: {{ candidate.symbol_number }}<br>
                                    {% if candidate.constituency %}Constituency: {{ candidate.constituency }}<br>{% endif %}
                                    {% if candidate.party %}Party: {{ candidate.party }}<br>{% endif %}
                                </div>
                            </div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-success" onclick="enableCapture({{ candidate.id }})">
                                    Select This Candidate
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Step 3: Camera Capture Section -->
            <div id="capture-section" class="capture-section">
                <h5>Step 3: Capture Photo</h5>
                <div id="selected-candidate-info" class="mb-3"></div>
                
                <form method="post" id="capture-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="capture">
                    <input type="hidden" name="candidate_id" id="selected_candidate_id">
                    <input type="hidden" name="image_data" id="image_data">
                    
                    <div class="text-center">
                        <video id="video" width="320" height="240" class="border rounded mb-3" autoplay></video>
                        <canvas id="canvas" width="320" height="240" style="display: none;"></canvas>
                        <br>
                        <div class="d-flex gap-2 justify-content-center">
                            <button type="button" class="btn btn-primary" onclick="startCamera()" id="start-camera-btn">
                                Start Camera
                            </button>
                            <button type="button" class="btn btn-warning" onclick="capture()" id="capture-btn" style="display: none;">
                                Capture Photo
                            </button>
                            <button type="submit" id="submit-btn" class="btn btn-success" style="display: none;">
                                Save Photo
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetCapture()" id="reset-btn" style="display: none;">
                                Retake
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let currentStep = 1;
let selectedCandidateId = null;
let cameraStream = null;

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const imageDataInput = document.getElementById('image_data');

// Update step indicator
function updateStepIndicator(step) {
    document.querySelectorAll('.step').forEach(s => {
        s.classList.remove('active', 'completed');
        const stepNum = parseInt(s.dataset.step);
        if (stepNum < step) {
            s.classList.add('completed');
        } else if (stepNum === step) {
            s.classList.add('active');
        }
    });
    currentStep = step;
}

// Initialize
{% if candidates %}
updateStepIndicator(2);
{% else %}
updateStepIndicator(1);
{% endif %}

// Select candidate and show details
function selectCandidate(candidateId) {
    // Clear previous selections
    document.querySelectorAll('.candidate-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelectorAll('.candidate-details').forEach(details => {
        details.classList.remove('show');
    });
    
    // Select current candidate
    const selectedCard = document.querySelector(`[data-candidate-id="${candidateId}"]`);
    selectedCard.classList.add('selected');
    
    // Show details
    const details = document.getElementById(`details-${candidateId}`);
    details.classList.add('show');
    
    selectedCandidateId = candidateId;
}

// Enable capture mode
function enableCapture(candidateId) {
    selectedCandidateId = candidateId;
    document.getElementById('selected_candidate_id').value = candidateId;
    
    // Get candidate info from the card
    const candidateCard = document.querySelector(`[data-candidate-id="${candidateId}"]`);
    const candidateName = candidateCard.querySelector('strong').textContent;
    const symbolNumber = candidateCard.querySelector('small').textContent;
    
    // Update selected candidate info
    document.getElementById('selected-candidate-info').innerHTML = `
        <div class="alert alert-info">
            <strong>Selected Candidate:</strong> ${candidateName}<br>
            <strong>${symbolNumber}</strong>
        </div>
    `;
    
    // Show capture section
    document.getElementById('capture-section').classList.add('show');
    updateStepIndicator(3);
    
    // Scroll to capture section
    document.getElementById('capture-section').scrollIntoView({ behavior: 'smooth' });
}

// Camera functions
function startCamera() {
    navigator.mediaDevices
        .getUserMedia({ video: true })
        .then((stream) => {
            cameraStream = stream;
            video.srcObject = stream;
            document.getElementById('start-camera-btn').style.display = 'none';
            document.getElementById('capture-btn').style.display = 'inline-block';
        })
        .catch((err) => {
            console.error('Error accessing camera:', err);
            alert('Error accessing camera. Please check permissions.');
        });
}

function capture() {
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    imageDataInput.value = canvas.toDataURL('image/png');
    
    // Show captured image preview
    const capturedImage = canvas.toDataURL('image/png');
    video.style.display = 'none';
    canvas.style.display = 'block';
    
    // Update buttons
    document.getElementById('capture-btn').style.display = 'none';
    document.getElementById('submit-btn').style.display = 'inline-block';
    document.getElementById('reset-btn').style.display = 'inline-block';
}

function resetCapture() {
    // Reset to video view
    video.style.display = 'block';
    canvas.style.display = 'none';
    imageDataInput.value = '';
    
    // Update buttons
    document.getElementById('capture-btn').style.display = 'inline-block';
    document.getElementById('submit-btn').style.display = 'none';
    document.getElementById('reset-btn').style.display = 'none';
}

// Clean up camera stream when page unloads
window.addEventListener('beforeunload', function() {
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
    }
});
</script>
{% endblock %}